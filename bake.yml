image: ubuntu:18.04
tasks:
  packages: |
    apt-get update
    apt-get install --yes build-essential curl

  tagref:
    dependencies:
      - packages
    command: |
      set -o pipefail
      curl https://raw.githubusercontent.com/stepchowfun/tagref/master/install.sh -LSfs | sh

  user: useradd --user-group --create-home user

  rust:
    dependencies:
      - packages
      - user
    user: user
    command: |
      set -o pipefail
      curl https://sh.rustup.rs -sSf | sh -s -- -y
      . $HOME/.cargo/env
      rustup component add clippy
      rustup component add rustfmt
      rm -rf "$(dirname "$(rustup which rustc)")/../share"

  tools:
    dependencies:
      - rust
      - tagref

  build:
    dependencies:
      - tools
    paths:
      - Cargo.lock
      - Cargo.toml
      - src
    user: user
    command: cargo build

  test:
    dependencies:
      - tools
    user: user
    command: cargo test

  lint:
    dependencies:
      - tools
    paths:
      - rustfmt.toml
    user: user
    command: |
      cargo fmt --all -- --check
      cargo clippy -- --deny clippy::pedantic
      tagref
